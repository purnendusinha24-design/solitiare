<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spider Solitaire – Custom Card Backs</title>
  <style>
    :root {
      /* Default card back – you can change this or use the upload button */
      --card-back-url: url("https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/Question_Mark_White_On_Black.svg/512px-Question_Mark_White_On_Black.svg.png");
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #020617, #020617 50%, #000);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(15, 23, 42, 0.98);
      border-bottom: 1px solid #1f2937;
    }

    header h1 {
      font-size: 1.2rem;
      margin: 0;
    }

    .controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      font-size: 0.85rem;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: none;
      padding: 0.35rem 0.9rem;
      font-size: 0.85rem;
      background: #1d4ed8;
      color: #f9fafb;
      font-weight: 600;
      transition: background 0.15s ease, transform 0.07s ease;
    }

    button:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }

    input[type="file"] {
      font-size: 0.8rem;
    }

    main {
      flex: 1;
      padding: 0.7rem 0.8rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }

    #top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      padding: 0 0.3rem;
    }

    #stock-area, #foundations {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .pile-label {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-bottom: 0.2rem;
    }

    .stock, .foundation-slot {
      width: 80px;
      height: 112px;
      border-radius: 8px;
      border: 1px dashed #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .stock {
      cursor: pointer;
    }

    .stock-count {
      position: absolute;
      bottom: 4px;
      right: 6px;
      font-size: 0.75rem;
      opacity: 0.8;
    }

    #tableau {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 0.6rem;
      margin-top: 0.5rem;
    }

    .column {
      width: 80px;
      position: relative;
      min-height: 112px;
    }

    .card {
      width: 80px;
      height: 112px;
      border-radius: 8px;
      position: absolute;
      left: 0;
      background-size: cover;
      background-position: center;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.8);
      transform-origin: center;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      user-select: none;
    }

    .card.face-down {
      background-image: var(--card-back-url);
      border: 1px solid #111827;
    }

    .card.face-up {
      background: linear-gradient(135deg, #111827, #020617);
      border: 1px solid #4b5563;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 4px 5px;
      color: #e5e7eb;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .card .rank-top,
    .card .rank-bottom {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
    }

    .card .rank-bottom {
      transform: rotate(180deg);
    }

    .card .center-suit {
      font-size: 1.4rem;
      text-align: center;
    }

    .card.selected {
      box-shadow: 0 0 0 2px #facc15, 0 8px 20px rgba(250, 204, 21, 0.6);
      transform: translateY(-4px);
    }

    .hint-text {
      font-size: 0.78rem;
      opacity: 0.8;
      padding-left: 0.3rem;
    }

    @media (max-width: 900px) {
      main {
        padding: 0.5rem;
      }
      #tableau {
        gap: 0.4rem;
      }
      .card,
      .stock,
      .foundation-slot,
      .column {
        width: 64px;
        height: 90px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Spider Solitaire – Custom Backs (1 Suit)</h1>
    <div class="controls">
      <button id="newGameBtn">New Game</button>
      <label>
        Card back image:
        <input type="file" id="cardBackInput" accept="image/*" />
      </label>
    </div>
  </header>

  <main>
    <div id="top-row">
      <div>
        <div class="pile-label">Stock</div>
        <div id="stock" class="stock">
          <span class="stock-count" id="stockCount"></span>
        </div>
        <div class="hint-text">Click to deal one row</div>
      </div>

      <div>
        <div class="pile-label">Completed Runs</div>
        <div id="foundations">
          <div class="foundation-slot" data-foundation="0"></div>
          <div class="foundation-slot" data-foundation="1"></div>
          <div class="foundation-slot" data-foundation="2"></div>
          <div class="foundation-slot" data-foundation="3"></div>
          <div class="foundation-slot" data-foundation="4"></div>
          <div class="foundation-slot" data-foundation="5"></div>
          <div class="foundation-slot" data-foundation="6"></div>
          <div class="foundation-slot" data-foundation="7"></div>
        </div>
      </div>
    </div>

    <div class="hint-text">
      Click a face-up card to select its sequence, then click another column to move it. Create K→A runs to score!
    </div>

    <section id="tableau">
      <!-- 10 columns -->
      <div class="column" data-column="0"></div>
      <div class="column" data-column="1"></div>
      <div class="column" data-column="2"></div>
      <div class="column" data-column="3"></div>
      <div class="column" data-column="4"></div>
      <div class="column" data-column="5"></div>
      <div class="column" data-column="6"></div>
      <div class="column" data-column="7"></div>
      <div class="column" data-column="8"></div>
      <div class="column" data-column="9"></div>
    </section>
  </main>

  <script>
    // ----- Game state -----
    const RANKS = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]; // A-K
    let deck = [];
    let tableaus = []; // 10 columns, each an array of card IDs
    let stock = [];    // remaining card IDs
    let foundations = []; // completed sequences (just counts)
    let selected = null; // {col, indexWithinColumn}

    const tableauEls = Array.from(document.querySelectorAll(".column"));
    const stockEl = document.getElementById("stock");
    const stockCountEl = document.getElementById("stockCount");
    const foundationsEls = Array.from(
      document.querySelectorAll(".foundation-slot")
    );

    // ----- Helpers -----
    function buildDeck() {
      deck = [];
      // Single-suit spider: 8 copies of each rank
      for (let copy = 0; copy < 8; copy++) {
        for (const rank of RANKS) {
          deck.push({
            id: deck.length,
            rank,
            suit: "♠",
            faceUp: false,
          });
        }
      }
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function startNewGame() {
      buildDeck();
      shuffle(deck);

      tableaus = Array.from({ length: 10 }, () => []);
      stock = [];
      foundations = [];
      selected = null;

      // Deal: first 4 columns get 6 cards, rest get 5
      let deckIndex = 0;
      for (let col = 0; col < 10; col++) {
        const numCards = col < 4 ? 6 : 5;
        for (let i = 0; i < numCards; i++) {
          const card = deck[deckIndex++];
          tableaus[col].push(card.id);
        }
      }

      // Turn last card of each column face-up
      for (let col = 0; col < 10; col++) {
        const colCards = tableaus[col];
        const lastId = colCards[colCards.length - 1];
        deck[lastId].faceUp = true;
      }

      // Rest goes to stock
      for (; deckIndex < deck.length; deckIndex++) {
        stock.push(deck[deckIndex].id);
      }

      renderAll();
    }

    function renderAll() {
      renderStock();
      renderTableaus();
      renderFoundations();
    }

    function renderStock() {
      stockCountEl.textContent = Math.floor(stock.length / 10);
      stockEl.classList.toggle("empty", stock.length === 0);
    }

    function renderFoundations() {
      foundationsEls.forEach((el, i) => {
        el.textContent = i < foundations.length ? "♠ K→A" : "";
      });
    }

    function renderTableaus() {
      tableauEls.forEach((colEl, colIndex) => {
        colEl.innerHTML = "";
        const cardsInCol = tableaus[colIndex];
        cardsInCol.forEach((cardId, idx) => {
          const card = deck[cardId];
          const cardEl = document.createElement("div");
          cardEl.classList.add("card");
          cardEl.dataset.column = colIndex;
          cardEl.dataset.index = idx;
          cardEl.style.top = `${idx * 24}px`;

          if (card.faceUp) {
            cardEl.classList.add("face-up");
            const rankSymbol = rankToSymbol(card.rank);
            cardEl.innerHTML = `
              <div class="rank-top">
                <span>${rankSymbol}</span><span>${card.suit}</span>
              </div>
              <div class="center-suit">${card.suit}</div>
              <div class="rank-bottom">
                <span>${rankSymbol}</span><span>${card.suit}</span>
              </div>
            `;
          } else {
            cardEl.classList.add("face-down");
          }

          if (
            selected &&
            selected.col === colIndex &&
            idx >= selected.index
          ) {
            cardEl.classList.add("selected");
          }

          cardEl.addEventListener("click", onCardClick);
          colEl.appendChild(cardEl);
        });
      });
    }

    function rankToSymbol(rank) {
      if (rank === 1) return "A";
      if (rank === 11) return "J";
      if (rank === 12) return "Q";
      if (rank === 13) return "K";
      return String(rank);
    }

    // ----- Game interactions -----
    function onCardClick(e) {
      const col = Number(e.currentTarget.dataset.column);
      const index = Number(e.currentTarget.dataset.index);
      const colCards = tableaus[col];
      const cardId = colCards[index];
      const card = deck[cardId];

      if (!card.faceUp) {
        // Only flip if it's the last card in the column
        if (index === colCards.length - 1) {
          card.faceUp = true;
          renderTableaus();
        }
        return;
      }

      if (!selected) {
        // select sequence from this card downward if valid
        if (!isValidSequenceFrom(col, index)) return;
        selected = { col, index };
        renderTableaus();
      } else {
        // Click same column: deselect
        if (selected.col === col && index >= selected.index) {
          selected = null;
          renderTableaus();
          return;
        }
        // Try move to this column
        if (moveSelectedTo(col)) {
          selected = null;
          renderAll();
          checkForAutoRuns();
        } else {
          // invalid move: just deselect
          selected = null;
          renderTableaus();
        }
      }
    }

    function isValidSequenceFrom(col, index) {
      const colCards = tableaus[col];
      for (let i = index; i < colCards.length - 1; i++) {
        const idA = colCards[i];
        const idB = colCards[i + 1];
        const a = deck[idA];
        const b = deck[idB];
        if (!a.faceUp || !b.faceUp) return false;
        if (a.rank !== b.rank + 1) return false; // descending by 1
      }
      return true;
    }

    function moveSelectedTo(targetCol) {
      if (selected.col === targetCol) return false;
      const fromCol = selected.col;
      const fromIndex = selected.index;

      const source = tableaus[fromCol];
      const dest = tableaus[targetCol];

      const movingIds = source.slice(fromIndex);
      const topCard = deck[movingIds[0]];

      if (dest.length === 0) {
        // Always ok to move sequence to empty column
      } else {
        const destTop = deck[dest[dest.length - 1]];
        if (!destTop.faceUp || destTop.rank !== topCard.rank + 1) {
          return false;
        }
      }

      // Perform move
      tableaus[fromCol] = source.slice(0, fromIndex);
      tableaus[targetCol] = dest.concat(movingIds);

      // Flip new top card in fromCol if needed
      const newColCards = tableaus[fromCol];
      if (newColCards.length > 0) {
        const topId = newColCards[newColCards.length - 1];
        deck[topId].faceUp = true;
      }

      return true;
    }

    function checkForAutoRuns() {
      // Look for K→A sequences in each column
      for (let col = 0; col < 10; col++) {
        const colCards = tableaus[col];
        if (colCards.length < 13) continue;

        // Check last 13 cards
        const sliceStart = colCards.length - 13;
        const ids = colCards.slice(sliceStart);
        let isRun = true;
        for (let i = 0; i < 13; i++) {
          const card = deck[ids[i]];
          if (!card.faceUp) {
            isRun = false;
            break;
          }
          if (card.rank !== 13 - i) {
            isRun = false;
            break;
          }
        }
        if (isRun) {
          // Remove them and add to foundations
          tableaus[col] = colCards.slice(0, sliceStart);
          foundations.push(ids);
          // Flip new top if needed
          const newCol = tableaus[col];
          if (newCol.length > 0) {
            deck[newCol[newCol.length - 1]].faceUp = true;
          }
        }
      }
      renderAll();
    }

    // Deal from stock
    stockEl.addEventListener("click", () => {
      if (stock.length === 0) return;
      // Can't deal if any column is empty (Spider rule)
      for (let col = 0; col < 10; col++) {
        if (tableaus[col].length === 0) return;
      }
      selected = null;
      for (let col = 0; col < 10; col++) {
        const cardId = stock.pop();
        const card = deck[cardId];
        card.faceUp = true;
        tableaus[col].push(cardId);
      }
      renderAll();
    });

    // New game button
    document.getElementById("newGameBtn").addEventListener("click", () => {
      startNewGame();
    });

    // Card back uploader
    document
      .getElementById("cardBackInput")
      .addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const url = `url("${e.target.result}")`;
          document.documentElement.style.setProperty(
            "--card-back-url",
            url
          );
        };
        reader.readAsDataURL(file);
      });

    // Initialize
    startNewGame();
  </script>
</body>
</html>
